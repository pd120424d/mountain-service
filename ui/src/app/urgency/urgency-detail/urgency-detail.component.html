<div class="urgency-detail-container">
  <div class="header">
    <button class="btn btn-secondary back-button" (click)="goBack()"
            [title]="'URGENCY_DETAIL.BACK_TO_LIST' | translate">
      <i class="fas fa-arrow-left"></i>
      {{ 'URGENCY_DETAIL.BACK_TO_LIST' | translate }}
    </button>
    <h2>{{ 'URGENCY_DETAIL.TITLE' | translate }}</h2>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading">
    <div class="spinner"></div>
    <p>{{ 'URGENCY_DETAIL.LOADING' | translate }}</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !isLoading" class="error-message">
    <p>{{ error }}</p>
    <button class="btn btn-secondary" (click)="loadUrgency()">
      {{ 'URGENCY_DETAIL.RETRY' | translate }}
    </button>
  </div>

  <!-- Urgency Details -->
  <div *ngIf="!isLoading && !error && urgency" class="urgency-details">
    <div class="urgency-info-card">
      <div class="card-header">
        <h3>{{ 'URGENCY_DETAIL.URGENCY_INFO' | translate }}</h3>
        <div class="urgency-badges">
          <span class="level-badge" [style.background-color]="getUrgencyLevelColor(urgency.level!)">
            {{ 'URGENCY_LEVEL.' + urgency.level?.toUpperCase() | translate }}
          </span>
          <span class="status-badge" [style.background-color]="getUrgencyStatusColor(urgency.status!)">
            {{ 'URGENCY_STATUS.' + (urgency.status?.toUpperCase()?.replace(' ', '_') || 'UNKNOWN') | translate }}
          </span>
          <span *ngIf="urgency?.assignedEmployeeId as assignedId" class="assigned-badge">
            {{ 'URGENCY_DETAIL.ASSIGNED_TO' | translate }}: {{ getEmployeeName(assignedId) }}
          </span>

        </div>
      </div>

      <div class="card-content">
        <div class="info-grid">
          <div class="info-item">
            <label>{{ 'URGENCY_DETAIL.ID' | translate }}:</label>
            <span>{{ urgency.id }}</span>
          </div>
          <div class="info-item">
            <label>{{ 'URGENCY_DETAIL.REPORTER_NAME' | translate }}:</label>
            <span>{{ getDisplayName(urgency) }}</span>
          </div>
          <div class="info-item">
            <label>{{ 'URGENCY_DETAIL.EMAIL' | translate }}:</label>
            <span>{{ urgency.email }}</span>
          </div>
          <div class="info-item">
            <label>{{ 'URGENCY_DETAIL.CONTACT_PHONE' | translate }}:</label>
            <span>{{ urgency.contactPhone }}</span>
          </div>
          <div class="info-item">
            <label>{{ 'URGENCY_DETAIL.LOCATION' | translate }}:</label>
            <span>{{ urgency.location }}</span>
          </div>
          <div class="info-item full-width">
            <label>{{ 'URGENCY_DETAIL.DESCRIPTION' | translate }}:</label>
            <p>{{ urgency.description }}</p>
          </div>
          <div class="info-item">
            <label>{{ 'URGENCY_DETAIL.CREATED_AT' | translate }}:</label>
            <span>{{ urgency.createdAt | localDateTime }}</span>
          </div>
          <div class="info-item">
            <label>{{ 'URGENCY_DETAIL.UPDATED_AT' | translate }}:</label>
            <span>{{ urgency.updatedAt | localDateTime }}</span>
          </div>
        </div>
        <div class="actions-row">
          <button class="btn btn-primary" *ngIf="canAssign()" [disabled]="isAssigning" (click)="onAssignToMe()">
            <span *ngIf="isAssigning">{{ 'URGENCY_DETAIL.ASSIGNING' | translate }}</span>
            <span *ngIf="!isAssigning">{{ 'URGENCY_DETAIL.ASSIGN_TO_ME' | translate }}</span>
          </button>
          <button class="btn btn-warning" *ngIf="canUnassign()" [disabled]="isUnassigning" (click)="onUnassign()">
            <span *ngIf="isUnassigning">{{ 'URGENCY_DETAIL.UNASSIGNING' | translate }}</span>
            <span *ngIf="!isUnassigning">{{ 'URGENCY_DETAIL.UNASSIGN' | translate }}</span>
          </button>
          <button class="btn btn-success" *ngIf="canResolve()" [disabled]="isResolving" (click)="onResolve()">
            <span *ngIf="isResolving">{{ 'URGENCY_DETAIL.RESOLVING' | translate }}</span>
            <span *ngIf="!isResolving">{{ 'URGENCY_DETAIL.RESOLVE' | translate }}</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Activities Section -->
    <div class="activities-section">
      <h3>{{ 'URGENCY_DETAIL.ACTIVITIES' | translate }}</h3>

      <!-- Add Activity Form (only when InProgress and assigned) -->
      <div class="add-activity-form" *ngIf="canAddActivity(); else activityDisabled">
        <h4>{{ 'URGENCY_DETAIL.ADD_ACTIVITY' | translate }}</h4>
        <form [formGroup]="activityForm" (ngSubmit)="onSubmitActivity()">
          <div class="form-group">
            <label for="description">{{ 'URGENCY_DETAIL.ACTIVITY_DESCRIPTION' | translate }}:</label>
            <textarea
              #activityTextarea
              id="description"
              formControlName="description"
              [class.error]="isFieldInvalid('description')"
              placeholder="{{ 'URGENCY_DETAIL.ACTIVITY_DESCRIPTION_PLACEHOLDER' | translate }}"
              rows="3"></textarea>
            <div *ngIf="isFieldInvalid('description')" class="error-message">
              {{ getFieldError('description') | translate }}
            </div>
          </div>

          <div class="form-actions">
            <button
              type="submit"
              [disabled]="activityForm.invalid || isSubmittingActivity"
              class="btn btn-primary">
              <span *ngIf="isSubmittingActivity">{{ 'URGENCY_DETAIL.SUBMITTING_ACTIVITY' | translate }}</span>
              <span *ngIf="!isSubmittingActivity">{{ 'URGENCY_DETAIL.ADD_ACTIVITY' | translate }}</span>
            </button>
          </div>
        </form>
      </div>
      <ng-template #activityDisabled>
        <div class="add-activity-disabled">
          <i class="fas fa-info-circle"></i>
          <span>{{ 'URGENCY_DETAIL.ADD_ACTIVITY_DISABLED' | translate }}</span>
        </div>
      </ng-template>

      <!-- Activities List -->
      <div class="activities-list">
        <div *ngIf="isLoadingActivities" class="loading-activities">
          <div class="spinner-small"></div>
          <p>{{ 'URGENCY_DETAIL.LOADING_ACTIVITIES' | translate }}</p>
        </div>

        <div *ngIf="!isLoadingActivities && activities.length === 0" class="no-activities">
          <p>{{ 'URGENCY_DETAIL.NO_ACTIVITIES' | translate }}</p>
        </div>

        <div *ngIf="!isLoadingActivities && activities.length > 0" class="activity-items">
          <div *ngFor="let activity of activities" class="activity-item">
            <div class="activity-header">
              <div class="activity-icon">
                <i class="fas fa-{{ getActivityIcon(activity) }}"></i>
              </div>
              <div class="activity-meta">
                <div class="activity-info">
                  <span class="activity-date">{{ getActivityDisplayTime(activity) }}</span>
                  <span *ngIf="activity.employeeId" class="activity-actor">
                    {{ 'URGENCY_DETAIL.ADDED_BY' | translate }} {{ getEmployeeName(activity.employeeId) }}
                  </span>
                </div>
              </div>
            </div>
            <div class="activity-description">
              <p>{{ activity.description }}</p>
            </div>
          </div>

        <div *ngIf="!isLoadingActivities && activities.length > 0" class="pagination-controls" style="display:flex;align-items:center;gap:8px;justify-content:flex-end;margin-top:12px;">
          <button class="btn btn-secondary" (click)="onPrevActivities()" [disabled]="activitiesPage <= 1">&laquo; {{ 'PREVIOUS' | translate }}</button>
          <span>{{ 'PAGE' | translate }} {{activitiesPage}} / {{totalActivitiesPages}} ({{totalActivities}} {{ 'TOTAL' | translate }})</span>
          <button class="btn btn-secondary" (click)="onNextActivities()" [disabled]="activitiesPage >= totalActivitiesPages">{{ 'NEXT' | translate }} &raquo;</button>
        </div>

        </div>
      </div>
    </div>
  </div>
</div>

<!-- Resolve Modal -->
<app-resolve-modal
  [isVisible]="showResolveModal"
  [urgencyId]="urgencyId"
  (result)="onResolveModalResult($event)">
</app-resolve-modal>
